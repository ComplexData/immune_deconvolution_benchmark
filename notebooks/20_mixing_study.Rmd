---
title: "R Notebook"
output: html_notebook
---

```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,
               cowplot,
               Biobase,
               pheatmap,
               magrittr)
```

Load dataset from schelker et al. 
```{r}
load("../data/single_cell_schelker.rda")
```

Let's repreduce the tsne plot from the publication
```{r, fig.width=10, fig.height=10}
pData(single_cell_schelker) %>% 
  ggplot(aes(x=tsneX1, y=tsneX2, colour=cell_type)) +
           geom_point(size=1) + 
           theme(legend.position="bottom")
```

Summary of the cell types
```{r}
pData(single_cell_schelker) %>% group_by(cell_type) %>% count()

```



```{r}
devtools::load_all("/storage/home/sturm/projects/immune_deconvolution_methods")
```


```{r}
set.seed(42)
bulk_eset = make_bulk_eset(n=100, eset=single_cell_schelker)
```


## run all methods and aggreate the results ina single table
```{r, fig.width=15, fig.height=5}
all_results = lapply(immunedeconv::deconvolution_methods, function(method) {
  res = deconvolute(bulk_eset, method, column="gene_symbol") 

  # summarise cell_types from the method that only map to a single cell_type in the reference dataset (namely monocytes and macrophages)
  res2 = res %>% map_results_to_dataset("single_cell_schelker") %>% 
            group_by(single_cell_schelker) %>%   
            summarise_all(funs(sum)) %>% 
            mutate(method=method)
  return(res2)
})

all_results %<>% bind_rows() %>%
  rename(cell_type = single_cell_schelker) %>%
  gather(sample, estimate, -cell_type, -method)

gold_standard = pData(bulk_eset) %>%
  rownames_to_column("sample") %>%
  gather(cell_type, true_fraction, -sample)

results_with_gold_standard = all_results %>%
  inner_join(gold_standard, by=c("sample", "cell_type"))
```


## correlation plot
```{r}
results_with_gold_standard %>%
  ggplot(aes(x=true_fraction, y=estimate)) +
  facet_grid(method ~ cell_type, scales="free_y") +
  geom_point() +
  stat_smooth()
```


## Calculate correlations for each method and cell type
```{r}
correlations = results_with_gold_standard %>%
  group_by(cell_type, method) %>%
  summarise(pearson=cor(estimate, true_fraction, method="pearson"))

correlations %>% ggplot(aes(x=method, y=pearson)) +
  geom_bar(stat="identity") +
  facet_wrap(~cell_type) + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1))
```



