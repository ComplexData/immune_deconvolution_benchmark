# Creating publication ready figures
```{r cache_fig_results, include=FALSE}
### Cache and load data
save(res_mixing_study, res_validation,
     res_sensitivity, res_spillover, res_methods_validity,
     file="../results/cache/results_for_figures.rda")
load("../results/cache/results_for_figures.rda")
theme_set(theme_cowplot(font_size=11)) # reduce default font siz

#### Figure dimensions
# (BioMed Central standard dimensions)
# full width page: 170mm
# full page height: 225mm (for figure and legend)
WIDTH = 170
```

```{r define_names, include=FALSE}
# Define names
tmp_names = names(config$deconvolution_methods)
tmp_names[tmp_names == "CIBERSORT (abs.)"] = "CIBERSORT abs"
method_names = tibble(
  method = config$deconvolution_methods,
  method_name = factor(tmp_names, levels=sort(tmp_names, decreasing = FALSE))
) %>% arrange(method_name)

cell_type_names = tibble(
  cell_type      = c("B cell", "Cancer associated fibroblast", "Dendritic cell", "Endothelial cell", "Macrophage/Monocyte", 
                     "NK cell", "T cell CD4+", "T cell CD4+ (non-regulatory)", "T cell CD8+", "T cell regulatory (Tregs)"),
  cell_type_name = c("B",      "CAF",                          "DC",             "Endothelial",      "Macro/Mono",
                     "NK",      "T CD4+",      "T CD4+ n.reg.",                "T CD8+",      "T reg")
)

validation_datasets = list("hoek"="Hoek (PBMC, n=8)", racle="Racle (melanoma, n=4)", schelker="Schelker (ovarian, n=3)")

HEATMAP_FONT_SIZE = 2.7
```


```{r, define_cor_table, include=FALSE}
#' plot correlations as a table colored by the absolute value.
plot_cor_table = function(data, dataset="none") {
  if(!("asterisk" %in% names(data))) {
    data %<>% mutate(asterisk = "no")
  }
  if(!("category" %in% names(data))) {
    data %<>% mutate(category = dataset)
  }
  data %>%
    mutate(pearson_text = if_else(pearson < 0, "< 0", as.character(round(pearson, 2))),
           pearson = if_else(pearson < 0, 0, pearson)) %>%
    mutate(asterisk = if_else(is.na(asterisk), "no", asterisk)) %>%
    mutate(pearson_text = if_else(asterisk == "yes", paste0(pearson_text, "*"), pearson_text)) %>%
    mutate(pearson_text = if_else(is.na(pearson), "n/a", pearson_text),
           pearson = if_else(is.na(pearson), 0, pearson)) %>%
    inner_join(method_names) %>%
    ggplot(aes(x=column, y=method_name)) +
      geom_tile(aes(fill=pearson)) +
      geom_text(aes(label=pearson_text), size=HEATMAP_FONT_SIZE) +
      scale_fill_distiller(type="div", palette = "RdYlGn", direction=1, values=c(0,1), limits=c(0, 1)) +
      theme_benchmark() +
      theme(axis.text.x.top=element_text(angle = 90, vjust = .5, hjust=0),
              legend.position="none",
              strip.text.x = element_text(size=11)) +
      facet_wrap(~category, scales = "free", strip.position="left", nrow=1) +
      # theme(strip.background = element_blank(),
      #       strip.text.x = element_blank()) +
      scale_x_discrete(position = "top") +
      xlab(NULL) +
      ylab(NULL) +
      theme_title(hjust=0.5)
}

```

```{r, method-validity-f1a, fig.width=7, fig.height=2, message=FALSE, warning=FALSE}
fun_breaks3 = function(limits) {
  breaks = signif(max(limits) * c(0.25, 0.75),1)
  names(breaks) = attr(breaks, "labels")
  breaks
}

tmp_cor = res_methods_validity$all_results_mapped %>% 
  group_by(method) %>% 
  do(make_cor(.$bulk, .$simulated)) %>% 
  mutate(pearson=round(pearson, 2)) %>%
  inner_join(method_names)

res_methods_validity$all_results_mapped %>% 
  inner_join(cell_type_names) %>% 
  inner_join(method_names) %>% 
  ggplot(aes(x=bulk, y=simulated)) + 
  geom_point(aes(colour=cell_type_name), size=.5) + 
  facet_wrap(~method_name, scales="free", nrow=1) + 
  theme(legend.position = "top") + 
  geom_text(data=tmp_cor, mapping=aes(label=paste0("r=", pearson), x=0, y=0), hjust=0, vjust=-8, size=2.4) + 
  panel_border() + 
  scale_x_continuous(breaks=fun_breaks3) + 
  scale_y_continuous(breaks=fun_breaks3) + 
  theme(strip.text=element_text(size=6), 
        panel.spacing = unit(2, "mm"), axis.text = element_text(size=8))
```


```{r, mixing-corr, fig.width=7, fig.height=6, message=FALSE}
fun_breaks = function(limits) {
  breaks = signif(max(limits) * c(0.25, 0.75),1)
  names(breaks) = attr(breaks, "labels")
  breaks
}
corr_annot = res_mixing_study$correlations %>% 
  select(method, cell_type, pearson) %>% 
  mutate(pearson = round(pearson, 2)) %>% 
  inner_join(method_names) %>%
  inner_join(cell_type_names) %>%
  distinct()
plot_mixing = res_mixing_study$all_results %>% 
  inner_join(method_names) %>%
  inner_join(cell_type_names) %>%
  ggplot(aes(x=true_fraction, y=estimate)) +
    geom_point(size=.2) +
    geom_text(data=corr_annot, mapping=aes(label=paste0("r=", pearson), x=-Inf, y=-Inf), hjust=-0.1, vjust=-8, size=2.4) + 
    facet_grid(method_name ~ cell_type_name, scales="free") +
    stat_smooth(aes(color=method), method="lm", size=.4) +
    scale_color_manual(values=color_scales$methods, na.value="grey") +
    scale_x_continuous(breaks=c(.2)) +
    scale_y_continuous(breaks=fun_breaks) +
    theme(legend.position = "none", strip.text=element_text(size=6), 
          panel.spacing = unit(.5, "mm"), axis.text = element_text(size=8)) +
    ylab("estimated fraction") + 
    xlab("true fraction") + 
    panel_border()

ggsave("../results/figures/correlations_mixing.pdf", width=WIDTH, height=140, units = "mm")
ggsave("../results/figures/correlations_mixing.png", width=WIDTH, height=140, units = "mm", dpi=600)
```

```{r validation_benchmark, include=FALSE}
# Validation Benchmark
ALL_CELLS = "All cells"
use_cell_types = c("B cell", "Dendritic cell", "Monocyte", "NK cell", "T cell CD4+", "T cell CD8+", "T cell")
  
validation = new.env()
validation$all_results = res_validation$all_results %>% filter(cell_type %in% use_cell_types) %>%
  filter(!(cell_type == "T cell" & dataset != "hoek"))  # otherwise t cells are counted twice!
  
validation$all_datasets = validation$all_results %>%
  group_by(method, cell_type) %>%
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(asterisk = if_else(cell_type == "Monocyte" & method == "mcp_counter", "yes", "no")) %>%
  mutate(category = "All datasets", column=cell_type)

validation$all_datasets_all_cells = validation$all_results %>%
  group_by(method) %>%
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = "All datasets") %>%
  mutate(column = cell_type)

validation$hoek = validation$all_results %>%
  filter(dataset == 'hoek') %>%
  group_by(method, cell_type) %>%
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(asterisk = if_else(cell_type == "Monocyte" & method == "mcp_counter", "yes", "no")) %>%
  mutate(category = validation_datasets$hoek) %>%
  mutate(column = cell_type)

validation$hoek_all_cells = validation$all_results %>%
  filter(dataset == 'hoek') %>%
  group_by(method) %>%
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = validation_datasets$hoek) %>%
  mutate(column = cell_type)

validation$racle_all_cells = validation$all_results %>%
  filter(dataset == 'racle') %>%
  group_by(method) %>%
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = validation_datasets$racle) %>%
  mutate(column = cell_type)

validation$schelker_all_cells = validation$all_results %>%
  filter(dataset == 'schelker_ovarian') %>%
  group_by(method) %>%
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = validation_datasets$schelker) %>%
  mutate(column = cell_type)

```



```{r, fig.height=3.5, include=FALSE}
p_validation_all_datasets = bind_rows(validation$all_datasets, validation$all_datasets_all_cells) %>%
  plot_cor_table() +
    geom_vline(xintercept = 1.5)

p_validation_hoek = bind_rows(validation$hoek, validation$hoek_all_cells) %>%
  plot_cor_table() +
    geom_vline(xintercept = 1.5)

p_validation_schelker = validation$schelker_all_cells %>%
  plot_cor_table()

p_validation_racle = validation$racle_all_cells %>%
  plot_cor_table()

print(p_validation_all_datasets)
print(p_validation_hoek)
print(p_validation_racle)
print(p_validation_schelker)
```



## Benchmark results
```{r, fig.height=3, fig.width=7, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Benchmark results main figure. "}
# combine heatmaps

## margins
MT1 = 1
MB1 = .5
MT2 = .2
MB2 = .7

## fine-tune formatting
p2_validation_all_datasets = p_validation_all_datasets  +
  theme(plot.margin = margin(t=MT1, b=MB1, unit="cm"))
p2_validation_hoek = p_validation_hoek + theme(axis.text.y=element_blank(),
                                                               plot.margin = margin(t=MT1, l=-.1, b=MB1, unit="cm"),
                                                               axis.ticks.y=element_blank())
p2_validation_racle = p_validation_racle + theme(axis.text.y=element_blank(),
                                                               plot.margin = margin(t=MT1, l=-.1, b=MB1, unit="cm"),
                                                               axis.ticks.y=element_blank())
p2_validation_schelker = p_validation_schelker + theme(axis.text.y=element_blank(),
                                                               plot.margin = margin(t=MT1, l=-.1, b=MB1, unit="cm"),
                                                               axis.ticks.y=element_blank())


plot_grid(p2_validation_all_datasets, p2_validation_hoek, p2_validation_racle, p2_validation_schelker, 
          align = "h", nrow = 1,
          axis="tb",
          hjust = -.1,
          label_size = 12,
          rel_widths = c(.6, .45, .13, .13))

# ggsave("../results/figures/summary.pdf")
# ggsave("../results/figures/summary.png", dpi=1200)
```


## detection limit / false positive figure
```{r detection-limit-fp, fig.width=6.9, fig.height=6.5, message=FALSE}
data = res_sensitivity$all_results %>% 
  filter(cell_type == input_cell_type) %>%
  mutate(frac_immune_cells = as.numeric(frac_immune_cells)/100) %>%
  filter(frac_immune_cells < .4) %>% 
  inner_join(method_names) %>%
  inner_join(cell_type_names) 

data_detection_limit = res_sensitivity$sensitivity %>%
  rename(cell_type = input_cell_type) %>% 
  inner_join(method_names) %>%
  inner_join(cell_type_names) %>%
  mutate(min_frac = as.numeric(min_frac)/100)

data_false_positives = res_sensitivity$specificity %>% 
  group_by(method, cell_type) %>% 
  summarise(fp_prediction = mean(estimate)) %>% 
  inner_join(method_names) %>% 
  inner_join(cell_type_names)

fun_breaks2 = function(limits) {
  breaks = signif(max(limits) * c(0, 0.5),1)
  names(breaks) = attr(breaks, "labels")
  breaks
}

data %>%
  ggplot(aes(x=frac_immune_cells, y=mean)) + 
    geom_ribbon(aes(ymin=mean-ci, ymax=mean+ci), alpha=.2) + 
    geom_point(size=.2, shape=4) + 
    # geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci)) + 
    panel_border() + 
    facet_grid(method_name ~ cell_type_name, scales = "free_y") + 
    scale_x_continuous(breaks=c(.1, .3)) +
    scale_y_continuous(breaks=fun_breaks2) +
    geom_vline(data=data_detection_limit, mapping=aes(xintercept=min_frac, colour="detection limit")) + 
    geom_hline(data=data_false_positives, mapping=aes(yintercept=fp_prediction, colour="false positive fraction")) + 
    ylab("average estimate") + 
    xlab("fraction of spike-in cells") + 
    theme(legend.position = "top", strip.text=element_text(size=6), 
          panel.spacing = unit(1, "mm"), axis.text = element_text(size=8)) 


```

## Migration charts for Spillover analysis
```{r, fig.width = 16, fig.height=10, include=FALSE}
methods = config$deconvolution_methods

# cibersort and cibersort abs are identical in this analysis, no need to include both.
methods = sort(methods[methods != "cibersort_abs"])
tmp_method_names = as.list(method_names %>% pull(method_name))
names(tmp_method_names) = method_names$method

migration = res_spillover$all_results %>%
  filter(dataset == "artificial_bulk") %>%
  group_by(method, cell_type, true_cell_type) %>%
  summarise(estimate = mean(estimate)) %>%
  ungroup()

noise_ratio = migration %>%
  group_by(method) %>%
  mutate(type = ifelse(cell_type == true_cell_type, "signal", "noise")) %>%
  group_by(method, type) %>%
  summarise(estimate = sum(estimate)) %>%
  spread(type, estimate) %>%
  mutate(noise_ratio = noise/(signal+noise)) %>%
  ungroup()

layout(matrix(seq(1, 6), 2, 3))
par(mar=rep(0.5, 4))
circos.par(cell.padding = rep(0, 4))
x = lapply(methods, function(method) {
      tmp_migration = migration %>%
        filter(method == !!method) %>%
        select(-method) %>%
        spread(cell_type, estimate) %>%
        as.data.frame() %>%
        column_to_rownames("true_cell_type") %>%
        as.matrix()

      chordDiagram(tmp_migration, directional = TRUE, transparency = .5,
                   grid.col = color_scales$immune_cells,
                   annotationTrack = c("grid"),
                   annotationTrackHeight = uh(5, "mm")
                   )

      text(0, 0, tmp_method_names[[method]], cex = 2.5)
      text(0, -0.2, as.character(round(filter(noise_ratio, method == !!method) %>% pull(noise_ratio), 2)), cex=2.2)
})

grid.echo()
migration_plot = grid.grab()
```

```{r, include=FALSE}
# make legend using ggplot
tmp_barplot_data = migration %>%
  select("cell type" = cell_type) %>%
  # add arbitrary value
  mutate(value = 1)

p = tmp_barplot_data %>%
  ggplot(aes(x=`cell type`, y=value, fill=`cell type`)) +
  geom_bar(stat='identity') +
  scale_fill_manual(values=color_scales$immune_cells) +
  theme(legend.position = "top", legend.justification = "center")
p

migration_legend = cowplot::get_legend(p)
```

```{r, include=FALSE}
# Plot differences with removed marker genes
rmgenes_plot = res_spillover$rm_marker_genes %>%
  inner_join(method_names) %>%
  filter(cell_type == "B cell") %>%
  mutate(dataset = if_else(dataset == "before", "no", "yes")) %>%
  ggplot(aes(x=dataset, y=predicted_fraction, colour=dataset)) +
    geom_quasirandom() +
    stat_summary(fun.y=mean, geom="crossbar", fun.ymin=mean, fun.ymax=mean, width=.5, color="black") +
    facet_wrap(~method_name, drop = TRUE) +
    stat_compare_means(paired = TRUE, method = "t.test", label="p.signif") +
    theme(legend.position = "none") +
    xlab("signature genes removed") +
    ylab("predicted fraction") +
    scale_color_brewer(type="qual", palette=2, direction = -1) +
    ylim(0, .75)

```

```{r fig.width = 8, fig.height=9, echo=FALSE, message=FALSE, fig.cap="Migration chart figure for paper. "}
# combine legend and plot
plot_grid(migration_plot, migration_legend, rmgenes_plot,
          nrow=3, rel_heights = c(0.7, .15, .4), align = "v", labels = c("A", "", "B"), axis="t")

ggsave("../results/figures/spillover_migration_chart.pdf")
ggsave("../results/figures/spillover_migration_chart.png", dpi=1200)
```
