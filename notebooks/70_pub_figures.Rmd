# Creating publication ready figures
```{r cache_fig_results, include=FALSE}
### Cache and load data
save(res_mixing_study, res_validation,
     res_sensitivity, res_spillover, res_methods_validity,
     file="../results/cache/results_for_figures.rda")
load("../results/cache/results_for_figures.rda")
theme_set(theme_cowplot(font_size=11)) # reduce default font siz
```

```{r define_names, include=FALSE}
# Define names
method_names = data.frame(
  method = immunedeconv::deconvolution_methods
  method_name = names(immunedeconv::deconvolution_methods)
)

validation_datasets = data.frame(
  dataset = c("hoek", "racle", "schelker_ovarian"),
  description = c("Hoek (PBMC)", "Racle (melanoma)", "Schelker (ovarian)")
)
```

```{r define_theme, include=FALSE}
# Collection of theme functions to add to every individual plot
theme_title = function(...) theme(plot.title = element_text(face="bold", size=11, ...))
theme_benchmark = function(...) {
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), ...)
}

```

```{r, define_cor_table, include=FALSE}
#' plot correlations as a table colored by the absolute value.
plot_cor_table = function(data) {
  if(!("macrophage_only" %in% names(data))) {
    data %<>% mutate(macrophage_only = "no")
  }
  if(!("category" %in% names(data))) {
    data %<>% mutate(category = "none")
  }
  data %>%
    mutate(pearson_text = if_else(pearson < 0, "< 0", as.character(round(pearson, 2))),
           pearson = if_else(pearson < 0, 0, pearson)) %>%
    mutate(macrophage_only = if_else(is.na(macrophage_only), "no", macrophage_only)) %>%
    mutate(pearson_text = if_else(macrophage_only == "yes", paste0(pearson_text, "*"), pearson_text)) %>%
    inner_join(method_names) %>%
    ggplot(aes(x=column, y=method_name)) +
      geom_tile(aes(fill=pearson)) +
      geom_text(aes(label=pearson_text), size=3) +
      scale_fill_distiller(type="div", palette = "RdYlGn", direction=1, values=c(0,1), limits=c(0, 1)) +
      theme_benchmark() +
      theme(axis.text.x.top=element_text(angle = 90, vjust = .5, hjust=0),
              legend.position="none",
              strip.text.x = element_text(size=11)) +
      facet_grid(~category, scales = "free_x", space="free_x") +
      theme(strip.background = element_blank(),
            strip.text.x = element_blank()) +
      scale_x_discrete(position = "top") +
      xlab(NULL) +
      ylab(NULL) +
      theme_title(hjust=0.5)
}

```


```{r correlation_plots, include=FALSE}
# Prepare data for correlation plots

# Noise benchmark
noise_sc = res_methods_validity$all_results %>%
  group_by(method) %>%
  do(make_cor(.$bulk, .$mean)) %>%
  mutate(column="stability single cell/bulk")

noise = noise_sc


# Simulation Benchmark
mixing =  res_mixing_study$correlations %>%
    rename(column=cell_type) %>%
    mutate(category="cell_type")

# Validation Benchmark

validation = res_validation$between_sample %>%
  rename(column=cell_type) %>%
  select(method, column, pearson)
```



```{r, fig.height=3.5, include=FALSE}
# make the correlation plots
p_noise = plot_cor_table(noise) + ggtitle("Noise")
p_mixing = plot_cor_table(mixing) + ggtitle("Simulation Benchmark")
p_validation = plot_cor_table(validation) + ggtitle("Validation")

print(p_noise)
print(p_mixing)
print(p_validation)
```

```{r, fig.height=3.5, include=FALSE}
# Make sensitivity plot. This plot looks similar to the correlation plots, however
# the colors are inversed and use a non-linear scale (as .5 would already be really bad)

p_sensitivity = res_sensitivity$sensitivity %>%
  filter(method != "mcp_counter") %>%
  mutate(min_frac=ifelse(is.infinite(min_frac), 100, min_frac)) %>%
  mutate(min_frac = min_frac/100) %>%
  mutate(min_frac_text = as.character(round(min_frac, 2))) %>%
  na.omit() %>%
  inner_join(method_names) %>%
  ggplot(aes(x=input_cell_type, y=method_name)) +
    geom_tile(aes(fill=min_frac)) +
    geom_text(aes(label=min_frac_text), size=3) +
    scale_fill_distiller(type="div", palette = "RdYlGn", direction=-1, values=c(0, .02, .1, 1)) +
    scale_alpha_manual(values=c("yes"=.3, "no"=1.)) +
    theme_benchmark() +
    theme(axis.text.x.top=element_text(angle = 90, vjust = .5, hjust=0),
            legend.position="none",
            strip.text.x = element_text(size=11)) +
    # facet_grid(~category) +
    scale_x_discrete(position = "top") +
    xlab(NULL) +
    ylab(NULL) +
    theme_title() +
    ggtitle("Sensitivity")

print(p_sensitivity)
```

```{r, include=FALSE}
# Specificity heatmap

# summarise by mean.
p_specificity = res_sensitivity$specificity %>%
  filter(method != "mcp_counter") %>%
  group_by(method, cell_type) %>%
  summarise(estimate = mean(estimate)) %>%
  mutate(estimate_text = as.character(round(estimate, 2))) %>%
  inner_join(method_names) %>%
  ggplot(aes(x=cell_type, y=method_name)) +
    geom_tile(aes(fill=estimate)) +
    geom_text(aes(label=estimate_text), size=3) +
    scale_fill_distiller(type="div", palette = "RdYlGn", direction=-1, values=c(0, .02, .1, 1)) +
    scale_alpha_manual(values=c("yes"=.3, "no"=1.)) +
    theme_benchmark() +
    theme(axis.text.x.top=element_text(angle = 90, vjust = .5, hjust=0),
            legend.position="none",
            strip.text.x = element_text(size=11)) +
    scale_x_discrete(position = "top", drop=FALSE) +
    xlab(NULL) +
    ylab(NULL) +
    theme_title() +
    ggtitle("Specificity")

print(p_specificity)
```

```{r, include=FALSE}
# Spillover migration plots

```


```{r, fig.height=3.5, fig.width=8, include=FALSE}
# Absolute deviation plot
tmp_cell_types = res_mixing_study$deviation_from_slope$cell_type %>% unique()
tmp_methods = config$abs_methods_final
tmp_matrix = crossing(tmp_cell_types, tmp_methods)
colnames(tmp_matrix) = c("cell_type", "method")
p_abs_deviation = res_mixing_study$deviation_from_slope %>%
  filter(method %in% tmp_methods) %>%
  right_join(tmp_matrix) %>%
  inner_join(method_names) %>%
   # na -> 0 workaround, otherwise text label does not show
   ggplot(aes(x=cell_type, y=ifelse(is.na(deviation), 0, deviation), alpha=macrophage_only)) +
      geom_bar(fill="black", stat="identity") +
      geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=.2, color="red") +
      geom_hline(yintercept=0, col="grey") +
      geom_text(aes(label=ifelse(is.na(deviation), "n/a", NA))) +
      facet_wrap(~method_name, nrow=1, labeller = label_wrap_gen()) +
      theme_benchmark() +
      theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
            legend.position="none",
            strip.text.x = element_text(size=9)) +
      # scale_fill_manual(values=color_scales$methods) +
      scale_alpha_manual(values=c("yes"=.3, "no"=1.)) +
      ggtitle("Absolute deviation") +
      xlab(NULL) +
      ylab("deviation from slope=1") +
      coord_flip(ylim=c(-2, 2)) +
      theme_title(hjust=0)

print(p_abs_deviation)
```

## Benchmark results, Sensitivity, Specificity and absolute deviation
```{r, fig.height=9, fig.width=7, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Benchmark results main figure. "}
# combine heatmaps

## margins
MT1 = .2
MB1 = .5
MT2 = .2
MB2 = .7

## fine-tune formatting
p2_noise = p_noise + theme(plot.margin = margin(t=MT1, b=MB1, unit="cm"),
                           plot.title=element_text(hjust=1))
p2_mixing = p_mixing + theme(axis.text.y=element_blank(), plot.margin = margin(t=MT1, l=0.2, b=MB1, unit="cm"),
                             plot.title=element_text(hjust=1))
p2_validation = p_validation + theme(axis.text.y=element_blank(), plot.margin = margin(t=MT1, l=.2, b=MB1, unit="cm"),
                                     plot.title=element_text(hjust=1))
p2_sensitivity = p_sensitivity + theme(plot.margin = margin(t=MT2, b=MB2, r=.5, unit= "cm"),
                                       plot.title=element_text(hjust=1))
p2_specificity = p_specificity + theme(axis.text.y = element_blank(),
                                       plot.margin = margin(l = 1, t=MT2, b=MB2, unit="cm"),
                                       plot.title=element_text(hjust=1))
p2_abs_deviation = p_abs_deviation + scale_x_discrete(position = "bottom") +
  theme(plot.margin = margin(t=0, unit="cm"), plot.title=element_text(hjust=1))

# align plots
plots_left = align_plots(p2_noise, p2_sensitivity, p2_abs_deviation, align="v", axis="l")
plots_right = align_plots(p2_validation, p2_specificity, plots_left[[3]], align="v", axis="r")

# first row
plot_heatmap = plot_grid(plots_left[[1]], p2_mixing, plots_right[[1]],
          align = "h", ncol = 3,
          axis="tb",
          rel_widths = c(.6, .9, .6), labels = c("A", "B", "C"))

# second row
plot_sens_spec = plot_grid(plots_left[[2]], plots_right[[2]],
                           align = "h", ncol = 2,
                           axis = "t",
                           rel_widths = c(.55, .35), labels = c("D", "E"))

# combine all
plot_grid(plot_heatmap,
          plot_sens_spec,
          plots_right[[3]],
          ncol=1,
          rel_heights = c(.40, .35, .3),
          labels = c("", "", "F"),
          align="h",
          axis="l")

ggsave("../results/figures/summary.pdf")
ggsave("../results/figures/summary.png", dpi=1200)
```


## Migration charts for Spillover analysis
```{r, fig.width = 16, fig.height=10, include=FALSE}
methods = immunedeconv::deconvolution_methods

# cibersort and cibersort abs are identical in this analysis, no need to include both.
methods = sort(methods[methods != "cibersort_abs"])
tmp_method_names = as.list(method_names %>% pull(method_name))
names(tmp_method_names) = method_names$method

migration = res_spillover$all_results %>%
  filter(dataset == "immune_reference") %>%
  # exclude neutrophils as not measured by most methods
  filter(true_cell_type != "Neutrophil") %>%
  # aggregate macro/mono into a single category
  mutate(true_cell_type = ifelse(true_cell_type %in% c("Macrophage M1", "Macrophage M2", "Monocyte"), "Macrophage/Monocyte", true_cell_type)) %>%
  mutate(true_cell_type = ifelse(true_cell_type == "T cell regulatory (Tregs)", "T cell CD4+", true_cell_type)) %>%
  group_by(method, cell_type, true_cell_type) %>%
  summarise(estimate = mean(estimate)) %>%
  ungroup()

noise_ratio = migration %>%
  group_by(method) %>%
  mutate(type = ifelse(cell_type == true_cell_type, "signal", "noise")) %>%
  group_by(method, type) %>%
  summarise(estimate = sum(estimate)) %>%
  spread(type, estimate) %>%
  mutate(noise_ratio = noise/(signal+noise)) %>%
  ungroup()

layout(matrix(seq(1, 6), 2, 3))
par(mar=rep(0.5, 4))
circos.par(cell.padding = rep(0, 4))
x = lapply(methods, function(method) {
      tmp_migration = migration %>%
        filter(method == !!method) %>%
        select(-method) %>%
        spread(cell_type, estimate) %>%
        as.data.frame() %>%
        column_to_rownames("true_cell_type") %>%
        as.matrix()

      chordDiagram(tmp_migration, directional = TRUE, transparency = .5,
                   grid.col = color_scales$immune_cells,
                   annotationTrack = c("grid"),
                   annotationTrackHeight = uh(5, "mm")
                   )

      text(0, 0, tmp_method_names[[method]], cex = 3)
      text(0, -0.2, as.character(round(filter(noise_ratio, method == !!method) %>% pull(noise_ratio), 2)), cex=2.8)
})

grid.echo()
migration_plot = grid.grab()
```

```{r, include=FALSE}
# make legend using ggplot
tmp_barplot_data = migration %>%
  select("cell type" = cell_type) %>%
  # add arbitrary value
  mutate(value = 1)

p = tmp_barplot_data %>%
  ggplot(aes(x=`cell type`, y=value, fill=`cell type`)) +
  geom_bar(stat='identity') +
  scale_fill_manual(values=color_scales$immune_cells) +
  theme(legend.position = "right")
p

migration_legend = get_legend(p)
```

```{r fig.width = 13, fig.height=7, echo=FALSE, message=FALSE, fig.cap="Migration chart figure for paper. "}
# combine legend and plot
plot_grid(migration_plot, migration_legend, nrow=1, rel_widths = c(.9, .15))

ggsave("../results/figures/spillover_migration_chart.pdf")
ggsave("../results/figures/spillover_migration_chart.png", dpi=1200)
```
