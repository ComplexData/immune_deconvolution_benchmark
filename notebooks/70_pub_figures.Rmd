# Creating publication ready figures
```{r cache_fig_results, include=FALSE}
### Cache and load data
save(res_mixing_study, res_validation,
     res_sensitivity, res_spillover, res_methods_validity,
     file="../results/cache/results_for_figures.rda")
load("../results/cache/results_for_figures.rda")
theme_set(theme_cowplot(font_size=11)) # reduce default font siz
```

```{r define_names, include=FALSE}
# Define names
method_names = data.frame(
  method = config$deconvolution_methods,
  method_name = names(config$deconvolution_methods)
)

validation_datasets = list("hoek"="Hoek (PBMC, n=8)", racle="Racle (melanoma, n=4)", schelker="Schelker (ovarian, n=3)")

HEATMAP_FONT_SIZE = 2.7
```


```{r, define_cor_table, include=FALSE}
#' plot correlations as a table colored by the absolute value.
plot_cor_table = function(data, dataset="none") {
  if(!("macrophage_only" %in% names(data))) {
    data %<>% mutate(macrophage_only = "no")
  }
  if(!("category" %in% names(data))) {
    data %<>% mutate(category = dataset)
  }
  data %>%
    mutate(pearson_text = if_else(pearson < 0, "< 0", as.character(round(pearson, 2))),
           pearson = if_else(pearson < 0, 0, pearson)) %>%
    mutate(macrophage_only = if_else(is.na(macrophage_only), "no", macrophage_only)) %>%
    mutate(pearson_text = if_else(macrophage_only == "yes", paste0(pearson_text, "*"), pearson_text)) %>%
    mutate(pearson_text = if_else(is.na(pearson), "n/a", pearson_text), 
           pearson = if_else(is.na(pearson), 0, pearson)) %>% 
    inner_join(method_names) %>%
    ggplot(aes(x=column, y=method_name)) +
      geom_tile(aes(fill=pearson)) +
      geom_text(aes(label=pearson_text), size=HEATMAP_FONT_SIZE) +
      scale_fill_distiller(type="div", palette = "RdYlGn", direction=1, values=c(0,1), limits=c(0, 1)) +
      theme_benchmark() +
      theme(axis.text.x.top=element_text(angle = 90, vjust = .5, hjust=0),
              legend.position="none",
              strip.text.x = element_text(size=11)) +
      facet_wrap(~category, scales = "free", strip.position="left", nrow=1) +
      # theme(strip.background = element_blank(),
      #       strip.text.x = element_blank()) +
      scale_x_discrete(position = "top") +
      xlab(NULL) +
      ylab(NULL) +
      theme_title(hjust=0.5)
}

```


```{r correlation_plots, include=FALSE}
# Prepare data for correlation plots

# Noise benchmark
noise_sc = res_methods_validity$all_results %>%
  group_by(method) %>%
  do(make_cor(.$bulk, .$mean)) %>%
  mutate(column="stability single cell/bulk", category=validation_datasets$schelker)

noise = noise_sc


# Simulation Benchmark
mixing =  res_mixing_study$correlations %>%
    rename(column=cell_type) %>%
    mutate(category="Simulated dataset")

```

```{r validation_benchmark, include=FALSE}
# Validation Benchmark
ALL_CELLS = "All cells"
use_cell_types = c("B cell", "Dendritic cell", "Macrophage/Monocyte", "NK cell", "T cell CD4+", "T cell CD8+", "T cell")
validation = new.env()
validation$all_results = res_validation$all_results %>% filter(cell_type %in% use_cell_types)
validation$all_datasets = validation$all_results %>%
  group_by(method, cell_type) %>% 
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(category = "All datasets", column=cell_type)

validation$all_datasets_all_cells = validation$all_results %>%
  filter(!(cell_type == "T cell" & dataset != "hoek")) %>%  # otherwise t cells are counted twice!
  group_by(method) %>%
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = "All datasets") %>%
  mutate(column = cell_type)

validation$hoek = validation$all_results %>%
  filter(dataset == 'hoek') %>% 
  group_by(method, cell_type) %>% 
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(category = validation_datasets$hoek) %>%
  mutate(column = cell_type)

validation$hoek_all_cells = validation$all_results %>%
  filter(dataset == 'hoek') %>% 
  group_by(method) %>% 
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = validation_datasets$hoek) %>%
  mutate(column = cell_type)

validation$racle_all_cells = validation$all_results %>%
  filter(dataset == 'racle') %>% 
  group_by(method) %>% 
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = validation_datasets$racle) %>%
  mutate(column = cell_type)

validation$schelker_all_cells = validation$all_results %>%
  filter(dataset == 'schelker_ovarian') %>% 
  group_by(method) %>% 
  do(make_cor(.$estimate, .$true_fraction)) %>%
  mutate(cell_type = ALL_CELLS, category = validation_datasets$schelker) %>%
  mutate(column = cell_type)

```



```{r, fig.height=3.5, include=FALSE}
# make the correlation plots
p_noise = plot_cor_table(noise) 
p_mixing = plot_cor_table(mixing)

p_validation_all_datasets = bind_rows(validation$all_datasets, validation$all_datasets_all_cells) %>%
  plot_cor_table() +
    geom_vline(xintercept = 1.5)

p_validation_hoek = bind_rows(validation$hoek, validation$hoek_all_cells) %>%
  plot_cor_table() +
    geom_vline(xintercept = 1.5)

p_validation_schelker = validation$schelker_all_cells %>%
  plot_cor_table() 

p_validation_racle = validation$racle_all_cells %>%
  plot_cor_table()

print(p_noise)
print(p_mixing)
print(p_validation_all_datasets)
print(p_validation_hoek) 
print(p_validation_racle)
print(p_validation_schelker)
```


```{r sens-spec-plot-pubready, include=FALSE}
# Specificity heatmap
tmp_sens = res_sensitivity$sensitivity %>%
  filter(method != "mcp_counter") %>%
  mutate(min_frac=ifelse(is.infinite(min_frac), 100, min_frac)) %>%
  mutate(min_frac = min_frac/100) %>%
  mutate(min_frac_text = as.character(round(min_frac, 2))) %>%
  na.omit() %>%
  mutate(category="Detection limit", cell_type=input_cell_type) %>%
  rename(estimate=min_frac, estimate_text=min_frac_text)

tmp_spec = res_sensitivity$specificity %>% mutate(category="False positives")

# summarise by mean.
p_sens_spec = bind_rows(tmp_sens, tmp_spec) %>%
  filter(method != "mcp_counter") %>%
  group_by(method, cell_type, category) %>%
  summarise(estimate = mean(estimate)) %>%
  mutate(estimate_text = as.character(round(estimate, 2))) %>%
  mutate(estimate = if_else(estimate > .3, .3, estimate)) %>% # clip estimate for better color coding. 
  inner_join(method_names) %>%
  ggplot(aes(x=cell_type, y=method_name)) +
    geom_tile(aes(fill=estimate)) +
    geom_text(aes(label=estimate_text), size=HEATMAP_FONT_SIZE) +
    scale_fill_distiller(type="div", palette = "RdYlGn", direction=-1, values=c(0, .02, .3, 1)) +
    scale_alpha_manual(values=c("yes"=.3, "no"=1.)) +
    theme_benchmark() +
    theme(axis.text.x.top=element_text(angle = 90, vjust = .5, hjust=0),
            legend.position="none",
            strip.text.x = element_text(size=11)) +
    scale_x_discrete(position = "top", drop=FALSE) +
    facet_wrap(~category, nrow=2) + 
    xlab(NULL) +
    ylab(NULL) +
    theme_title() 
    

print(p_sens_spec)
```


```{r, fig.height=3.5, fig.width=8, include=FALSE}
# Absolute deviation plot
tmp_cell_types = res_validation$slope %>% pull(cell_type) %>% unique() 
tmp_methods = config$abs_methods_final
tmp_n_samples = res_validation$slope %>% select(cell_type, n) %>% distinct()
tmp_matrix = crossing(tmp_cell_types, tmp_methods) 
colnames(tmp_matrix) = c("cell_type", "method")
p_abs_deviation = res_validation$slope %>% 
  select(-n) %>% 
  right_join(tmp_matrix) %>%
  inner_join(method_names) %>%
  left_join(tmp_n_samples) %>% 
  mutate(cell_type_name = sprintf("%s [n=%i]", cell_type, n)) %>%
   # na -> 0 workaround, otherwise text label does not show
   ggplot(aes(x=cell_type_name, y=ifelse(is.na(slope), 1, slope))) +
      geom_crossbar(aes(ymin=slope, ymax=slope), colour="black") +
      geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=.2, color="black") +
      geom_hline(yintercept=1, col="grey") +
      geom_text(aes(label=ifelse(is.na(slope), "n/a", NA))) +
      facet_wrap(~method_name, nrow=2, labeller = label_wrap_gen()) +
      theme_benchmark() +
      theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
            legend.position="none",
            strip.text.x = element_text(size=9)) +
      # scale_fill_manual(values=color_scales$methods) +
      scale_alpha_manual(values=c("yes"=.3, "no"=1.)) + 
      xlab(NULL) +
      ylab("slope of linear model") +
      coord_flip() +
      theme_title(hjust=0)

print(p_abs_deviation)
```

```{r rmse_plot, fig.height=6, fig.width=3, include=FALSE}
p_abs_rmse = res_validation$rmse %>%
  right_join(tmp_matrix) %>%
  inner_join(method_names) %>%
  mutate(rmse_text = as.character(round(rmse, 2))) %>%
  mutate(column="RMSE") %>%
  ggplot(aes(x=column, y=cell_type)) +
    geom_tile(aes(fill=rmse)) +
    geom_text(aes(label=rmse_text), size=3) +
    scale_fill_distiller(type="div", palette = "RdYlGn", direction=-1, na.value="white") +
    scale_alpha_manual(values=c("yes"=.3, "no"=1.)) +
    theme_benchmark() +
    theme(axis.text.x.top=element_text(angle = 90, vjust = .5, hjust=0),
            legend.position="none",
            strip.text.x = element_blank()) +
    scale_x_discrete(position = "top", drop=FALSE) +
    facet_wrap(~method_name, nrow=2) + 
    xlab(NULL) +
    ylab(NULL) +
    theme_title()

print(p_abs_rmse)
```


## Benchmark results, detection limit, false positives and absolute deviation
```{r, fig.height=9, fig.width=10, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Benchmark results main figure. "}
# combine heatmaps

## margins
MT1 = 1
MB1 = .5
MT2 = .2
MB2 = .7

## fine-tune formatting
p2_noise = p_noise + theme(plot.margin = margin(t=MT1, b=MB1, unit="cm"))
p2_mixing = p_mixing + theme(axis.text.y=element_blank(), plot.margin = margin(t=MT1, l=0.2, b=MB1, unit="cm"),
                             axis.ticks.y=element_blank())
p2_validation_all_datasets = p_validation_all_datasets + theme(axis.text.y=element_blank(), 
                                                               plot.margin = margin(t=MT1, l=.2, b=MB1, unit="cm"),
                                                               axis.ticks.y=element_blank())
p2_validation_hoek = p_validation_hoek + theme(axis.text.y=element_blank(), 
                                                               plot.margin = margin(t=MT1, l=-.1, b=MB1, unit="cm"),
                                                               axis.ticks.y=element_blank())
p2_validation_racle = p_validation_racle + theme(axis.text.y=element_blank(), 
                                                               plot.margin = margin(t=MT1, l=-.1, b=MB1, unit="cm"),
                                                               axis.ticks.y=element_blank())
p2_validation_schelker = p_validation_schelker + theme(axis.text.y=element_blank(), 
                                                               plot.margin = margin(t=MT1, l=-.1, b=MB1, unit="cm"),
                                                               axis.ticks.y=element_blank())


p2_sens_spec = p_sens_spec + theme(plot.margin = margin(r=3, unit="cm"))
p2_abs_deviation = p_abs_deviation
p2_abs_rmse = p_abs_rmse + theme(axis.text.y=element_blank(), axis.ticks = element_blank(),
                             plot.margin = margin(l=-.2, unit="cm"))

# align plots
plots_left = align_plots(p2_noise, p2_sens_spec, align="v", axis="l")
plots_right = align_plots(p2_validation_schelker, p2_abs_rmse, align="v", axis="r")

# first row
plot_heatmap = plot_grid(plots_left[[1]], p2_mixing, p2_validation_all_datasets, 
                         p2_validation_hoek, p2_validation_racle, plots_right[[1]],
          align = "h", nrow = 1,
          axis="tb",
          hjust = -.1,
          label_size = 12,
          rel_widths = c(.4, .75, .6, .45, .13, .13), labels = c("A Noise", "B Simulation Benchmark", "C Validation Benchmark"))

# second row
plot_second_row = plot_grid(plots_left[[2]], p2_abs_deviation, plots_right[[2]],
                           align = "h", ncol = 3,
                           axis = "t",
                           rel_widths = c(.4, .4, 0.04), labels = c("D", "E"))

# combine all
plot_grid(plot_heatmap,
          plot_second_row,
          ncol=1,
          rel_heights = c(.45, .6),
          align="h",
          axis="l")

ggsave("../results/figures/summary.pdf")
ggsave("../results/figures/summary.png", dpi=1200)
```


## Migration charts for Spillover analysis
```{r, fig.width = 16, fig.height=10, include=FALSE}
methods = config$deconvolution_methods

# cibersort and cibersort abs are identical in this analysis, no need to include both.
methods = sort(methods[methods != "cibersort_abs"])
tmp_method_names = as.list(method_names %>% pull(method_name))
names(tmp_method_names) = method_names$method

# migration = res_spillover$all_results %>%
#   filter(dataset == "immune_reference") %>%
#   # exclude neutrophils as not measured by most methods
#   filter(true_cell_type != "Neutrophil") %>%
#   # aggregate macro/mono into a single category
#   mutate(true_cell_type = ifelse(true_cell_type %in% c("Macrophage M1", "Macrophage M2", "Monocyte"), "Macrophage/Monocyte", true_cell_type)) %>%
#   mutate(true_cell_type = ifelse(true_cell_type == "T cell regulatory (Tregs)", "T cell CD4+", true_cell_type)) %>%
#   group_by(method, cell_type, true_cell_type) %>%
#   summarise(estimate = mean(estimate)) %>%
#   ungroup()

migration = res_spillover$all_results %>%
  filter(dataset == "artificial_bulk") %>% 
  group_by(method, cell_type, true_cell_type) %>%
  summarise(estimate = mean(estimate)) %>%
  ungroup()

noise_ratio = migration %>%
  group_by(method) %>%
  mutate(type = ifelse(cell_type == true_cell_type, "signal", "noise")) %>%
  group_by(method, type) %>%
  summarise(estimate = sum(estimate)) %>%
  spread(type, estimate) %>%
  mutate(noise_ratio = noise/(signal+noise)) %>%
  ungroup()

layout(matrix(seq(1, 6), 2, 3))
par(mar=rep(0.5, 4))
circos.par(cell.padding = rep(0, 4))
x = lapply(methods, function(method) {
      tmp_migration = migration %>%
        filter(method == !!method) %>%
        select(-method) %>%
        spread(cell_type, estimate) %>%
        as.data.frame() %>%
        column_to_rownames("true_cell_type") %>%
        as.matrix()

      chordDiagram(tmp_migration, directional = TRUE, transparency = .5,
                   grid.col = color_scales$immune_cells,
                   annotationTrack = c("grid"),
                   annotationTrackHeight = uh(5, "mm")
                   )

      text(0, 0, tmp_method_names[[method]], cex = 2.5)
      text(0, -0.2, as.character(round(filter(noise_ratio, method == !!method) %>% pull(noise_ratio), 2)), cex=2.2)
})

grid.echo()
migration_plot = grid.grab()
```

```{r, include=FALSE}
# make legend using ggplot
tmp_barplot_data = migration %>%
  select("cell type" = cell_type) %>%
  # add arbitrary value
  mutate(value = 1)

p = tmp_barplot_data %>%
  ggplot(aes(x=`cell type`, y=value, fill=`cell type`)) +
  geom_bar(stat='identity') +
  scale_fill_manual(values=color_scales$immune_cells) +
  theme(legend.position = "top", legend.justification = "center")
p

migration_legend = cowplot::get_legend(p)
```

```{r}
# Plot differences with removed marker genes
rmgenes_plot = res_spillover$rm_marker_genes %>% 
  inner_join(method_names) %>%
  filter(cell_type == "B cell") %>% 
  mutate(dataset = if_else(dataset == "before", "no", "yes")) %>% 
  ggplot(aes(x=dataset, y=predicted_fraction, colour=dataset)) +
    geom_quasirandom() + 
    stat_summary(fun.y=mean, geom="crossbar", fun.ymin=mean, fun.ymax=mean, width=.5, color="black") + 
    facet_wrap(~method_name, drop = TRUE) + 
    stat_compare_means(paired = TRUE, method = "t.test", label="p.signif") + 
    theme(legend.position = "none") + 
    xlab("signature genes removed") + 
    ylab("predicted fraction") + 
    scale_color_brewer(type="qual", palette=2, direction = -1) + 
    ylim(0, .75)

```

```{r fig.width = 8, fig.height=9, echo=FALSE, message=FALSE, fig.cap="Migration chart figure for paper. "}
# combine legend and plot
plot_grid(migration_plot, migration_legend, rmgenes_plot, 
          nrow=3, rel_heights = c(0.7, .15, .4), align = "v", labels = c("A", "", "B"), axis="t")

ggsave("../results/figures/spillover_migration_chart.pdf")
ggsave("../results/figures/spillover_migration_chart.png", dpi=1200)
```
