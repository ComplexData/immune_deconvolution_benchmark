# Sensitivity analysis
How many cells do we need for a method to detect immune cell infiltration?


```{r, fig.height=18, fig.width=25, cache=TRUE}
if(!file.exists("../results/sensitivity_analysis_res.rda")) {
  background_cells = c(cell_types$cancer, cell_types$other)
  n_background_cells = single_cell_schelker$eset %>% pData() %>%
    filter(cell_type %in% background_cells) %>%
    group_by(cell_type) %>%
    count() %>% 
    {'names<-'(.$n, .$cell_type)}
  
  n_immune_cells = rep(c(0:10
                       , seq(15, 50, 5)
                       , seq(60, 100, 10)
                       , seq(200, 1000, 100)
                       ), 5)
  
  registerDoMC(cores=16)
  res = foreach(input_cell_type = cell_types$immune_cells, .combine=bind_rows) %:% 
    foreach(method = immunedeconv::deconvolution_methods, .combine=bind_rows) %dopar% {
      expr_mat = lapply(n_immune_cells, function(n) {
        cell_n =  c(n_background_cells, n)
        names(cell_n) = c(names(n_background_cells), input_cell_type)
        cell_frac = cell_n/sum(cell_n)
        make_random_bulk(eset=single_cell_schelker$eset, cell_fractions = cell_frac, n_cells = sum(cell_n))
      }) %>% bind_cols() %>% as.matrix()
      
      
      rownames(expr_mat) = rownames(single_cell_schelker$eset %>% exprs())
      
      deconv_res = deconvolute(expr_mat, method)
      
      deconv_res2 = deconv_res %>% as.data.frame() %>% column_to_rownames("cell_type") %>% t() %>% as.data.frame()
      deconv_res2$n_cells = as.factor(n_immune_cells) 
      deconv_res2 %<>% 
        gather(cell_type, estimate, -n_cells) %>%
        mutate(method=method, input_cell_type=input_cell_type)
    }
  
  sensitivity_analysis_res = res
  save(sensitivity_analysis_res, file="../results/sensitivity_analysis_res.rda")
}


```


```{r, fig.height=18, fig.width=25, cache=TRUE}
load("../results/sensitivity_analysis_res.rda")
sensitivity_analysis_res %>% 
  # filter(cell_type %in% c("T CD8+ (CTL)", "T CD4+ (naÃ¯ve)")) %>%
  group_by(method, input_cell_type, cell_type, n_cells) %>% 
  summarise_all(funs(mean, sd, n=length)) %>%
  mutate(ci=qt(0.975,df=n-1)*sd/sqrt(n)) %>% 
  ggplot(aes(x=n_cells, y=mean, colour=cell_type)) +
    geom_line() + 
    geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci)) + 
    theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position="top") + 
    facet_grid(method~input_cell_type, scales = "free_y")
```

tmp sens figure for presentation (only CD8)
```{r, fig.width=12, fig.height=8}
n_bg_cells = 1813

p2 = sensitivity_analysis_res %>% 
  filter(input_cell_type == "CD8+ T cells") %>%
  group_by(method, input_cell_type, cell_type, n_cells) %>% 
  summarise_all(funs(mean, sd, n=length)) %>%
  mutate(ci=qt(0.975,df=n-1)*sd/sqrt(n)) %>% 
  mutate(percent_cd8=100*as.numeric(as.character(n_cells))/(as.numeric(as.character(n_cells)) + n_bg_cells)) %>%
  mutate(percent_cd8c=as.character(round(percent_cd8, 2))) %>%
  arrange(percent_cd8) %>% 
  mutate(percent_cd8f=factor(percent_cd8c, levels=percent_cd8c))

# p2 %>%
#   ggplot(aes(x=percent_cd8f, y=mean, colour=cell_type)) +
#     geom_line() + 
#     geom_errorbar(aes(ymin=mean-ci, ymax=mean+ci)) + 
#     theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
#         legend.position="top") + 
#     facet_wrap(~method, scales = "free_y")


```


Fraction CD8 predicted at 0% infiltration
```{r}
# sensitivity_analysis_res %>% 
#   filter(input_cell_type == "CD8+ T cells", cell_type == "T CD8+ (CTL)", n_cells==0, method!="mcp_counter") %>%
#   ggplot(aes(x=method, y=estimate, fill=method)) + 
#   geom_boxplot() + 
#   theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
#         legend.position="top") +
#   scale_fill_manual(values=color_scales$methods)

```
