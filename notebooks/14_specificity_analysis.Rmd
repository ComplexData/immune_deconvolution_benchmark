# Specificity Analysis

## Create datasets

 * immune reference: bulk RNA seq profiles from sorted immune cells (=quanTIseq training data)
 * artificial bulk: simulated bulk RNA seq profiles from single cells (e.g. only T cells)
 * artificial bulk with background: simulated bulk RNA seq profiles from single cells with ~80% other cells (cancer, fibroblasts, ...)
 
 
```{r}
show_cell_types = c("B cell", "Dendritic cell", "Macrophage/Monocyte", "NK cell", "T cell CD4+", "T cell CD8+")
```

 
```{r, cache=TRUE}
set.seed(42)

sample_types = rep(show_cell_types, 5)
## make artificial bulk sample
artificial_bulk = lapply(sample_types, function(cell_type) {
  cell_n = make_cell_fraction_vector(cell_type, n=500, background=NULL)
  cell_frac = cell_n/sum(cell_n)
  make_random_bulk(single_cell_schelker$eset, cell_frac, n_cells=500)
}) %>% bind_cols() %>% as.matrix()

rownames(artificial_bulk) = rownames(single_cell_schelker$eset %>% exprs())


## make artificial bulk samples with background
artificial_bulk_bg = lapply(sample_types, function(cell_type) {
  cell_n = make_cell_fraction_vector(cell_type, n=100,
                                     background=round(400*(cell_types$n_background_cells/sum(cell_types$n_background_cells))))
  assert("sample has 500 cells", sum(cell_n) >= 499 & sum(cell_n) <= 501)
  cell_frac = cell_n/sum(cell_n)
  make_random_bulk(single_cell_schelker$eset, cell_frac, n_cells=500)
}) %>% bind_cols() %>% as.matrix()

rownames(artificial_bulk_bg) = rownames(single_cell_schelker$eset %>% exprs())
```


## Run the deconvolution
We first run all methods that are integrated in the `immune_deconvolution_methods` are package automatically in a loop. 
```{r, cache=TRUE, message=FALSE}
datasets = list(
  immune_reference = immune_cell_reference$expr_mat,
  artificial_bulk = artificial_bulk,
  artificial_bulk_bg = artificial_bulk_bg
)
dataset_gold_standard = list(
  immune_reference = immune_cell_reference$sample_description %>%
    select(sample, true_cell_type=cell_type),
  artificial_bulk = tibble(sample=colnames(artificial_bulk), true_cell_type=sample_types),
  artificial_bulk_bg = tibble(sample=colnames(artificial_bulk), true_cell_type=sample_types)
)

all_results_file = "../results/specificity_analysis_res.rda"
if(!file.exists(all_results_file)) {
  all_results = sapply(names(datasets), function(dataset) {
                    sapply(immunedeconv::deconvolution_methods, function(method) {
                      deconvolute(datasets[[dataset]], method)
                    }, USE.NAMES = TRUE, simplify = FALSE)
                }, USE.NAMES = TRUE, simplify = FALSE)
  save(all_results, file=all_results_file)
}
load(all_results_file)
```

### Postprocess the deconvolution results
```{r, cache=TRUE, message=FALSE}
all_results2 =  foreach(dataset = names(datasets), 
                        gold_standard = dataset_gold_standard,
                        .combine = bind_rows) %:% 
                  foreach(method = immunedeconv::deconvolution_methods,
                          .combine = bind_rows) %do% {
                            all_results[[dataset]][[method]] %>% 
                              map_result_to_celltypes(show_cell_types, method) %>% 
                              as_tibble(rownames = "cell_type") %>%
                              gather(sample, estimate, -cell_type) %>%
                              mutate(method=method, dataset=dataset) %>% 
                              inner_join(gold_standard)
                } %>% 
  na.omit()
```


## Results
```{r, fig.width=24, fig.height=24, cache=TRUE}
all_results2 %>%
  filter(true_cell_type %in% show_cell_types, cell_type %in% show_cell_types) %>% 
  ggplot(aes(x=cell_type, y=estimate, fill=dataset)) + 
    geom_boxplot(position = position_dodge2(preserve = "total")) + 
    facet_grid(method~true_cell_type+dataset, scales="free_y") + 
    theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1)) +
    background_grid(major = "xy", minor = "none")
   


```


### Summary figure: signal to noise ratio
```{r, fig.width=8, fig.height=8, cache=TRUE}
signal_noise_res = all_results2 %>% 
  mutate(signal_noise=if_else(cell_type == true_cell_type, "signal", "noise")) %>%
  group_by(dataset, sample, method, true_cell_type, signal_noise) %>%
  summarise(estimate=sum(estimate)) %>% 
  spread(signal_noise, estimate) %>% 
  mutate(noise_ratio = noise/(noise+signal)) %>%
  ungroup() %>% 
  na.omit()


signal_noise_res %>% 
  ggplot(aes(x=method, y=noise_ratio, color=dataset)) + 
  geom_boxplot(position = position_dodge2(preserve = "total")) +
  facet_wrap(~true_cell_type) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1))

```
