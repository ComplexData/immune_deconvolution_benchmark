# Specificity Analysis

## Create datasets

 * immune reference: bulk RNA seq profiles from sorted immune cells (=quanTIseq training data)
 * artificial bulk: simulated bulk RNA seq profiles from single cells (e.g. only T cells)
 * artificial bulk with background: simulated bulk RNA seq profiles from single cells with ~80% other cells (cancer, fibroblasts, ...)
 
```{r, cache=TRUE}
set.seed(42)
background_cells = c(cell_types$cancer, cell_types$other)

n_background_cells = single_cell_schelker$eset %>% pData() %>%
    filter(cell_type %in% background_cells) %>%
    group_by(cell_type) %>%
    count() %>% 
    {'names<-'(.$n, .$cell_type)}

frac_background_cells = n_background_cells/sum(n_background_cells)


sample_types = rep(cell_types$immune_cells, 5)
## make artificial bulk sample
artificial_bulk = lapply(sample_types, function(cell_type) {
  cell_frac = c(1.)
  names(cell_frac) = cell_type
  make_random_bulk(single_cell_schelker$eset, cell_frac, n_cells=500)
}) %>% bind_cols() %>% as.matrix()

rownames(artificial_bulk) = rownames(single_cell_schelker$eset %>% exprs())


## make artificial bulk samples with background
artificial_bulk_bg = lapply(sample_types, function(cell_type) {
  cell_frac = c(.3, .7*frac_background_cells)
  names(cell_frac) = c(cell_type, names(frac_background_cells))
  make_random_bulk(single_cell_schelker$eset, cell_frac, n_cells=500)
}) %>% bind_cols() %>% as.matrix()

rownames(artificial_bulk_bg) = rownames(single_cell_schelker$eset %>% exprs())
```


## Run the deconvolution
We first run all methods that are integrated in the `immune_deconvolution_methods` are package automatically in a loop. 
```{r, cache=TRUE}
datasets = list(
  immune_reference = immune_cell_reference$expr_mat,
  artificial_bulk = artificial_bulk,
  artificial_bulk_bg = artificial_bulk_bg
)
dataset_gold_standard = list(
  immune_reference = immune_cell_reference$sample_description %>%
    select(sample, true_cell_type=cell_type),
  artificial_bulk = tibble(sample=colnames(artificial_bulk), true_cell_type=sample_types),
  artificial_bulk_bg = tibble(sample=colnames(artificial_bulk), true_cell_type=sample_types)
)

all_results_file = "../results/specificity_analysis_res.rda"
if(!file.exists(all_results_file)) {
  all_results = foreach(dataset = datasets, 
                        .final = function(x) setNames(x, names(datasets))) %do% {
                          
                            foreach(method = immunedeconv::deconvolution_methods, 
                                    .final = function(x) setNames(x, immunedeconv::deconvolution_methods)) %dopar% {
                                          deconvolute(dataset, method) 
                                    }
                        }
  save(all_results, file=all_results_file)
}
load(all_results_file)
```

```{r}
show_cell_types = c("B cell", "Dendritic cell", "Macrophage/Monocyte", "NK cell", "T cell CD4+", "T cell CD8+")
```

### Postprocess the deconvolution results
```{r}
foreach(dataset = names(datasets), 
        gold_standard = dataset_gold_standard,
        .combine = bind_rows) %:% 
  foreach(method = immunedeconv::deconvolution_methods,
          .combine = bind_rows) %do% {
            all_results[[dataset]][[method]] %>% 
              map_result_to_celltypes(show_cell_types, method) %>% 
              as_tibble(rownames = "cell_type") %>%
              gather(sample, estimate, -cell_type) %>%
              mutate(method=method, dataset=dataset) %>% 
              inner_join(gold_standard)
}
```


## Results
```{r, fig.width=24, fig.height=24}
all_results %>%
  filter(true_cell_type %in% show_cell_types, cell_type %in% show_cell_types) %>% 
  ggplot(aes(x=cell_type, y=estimate, fill=dataset)) + 
    geom_boxplot(position = position_dodge2(preserve = "total")) + 
    facet_grid(method~true_cell_type, scales="free_y") + 
    theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1)) 
   


```



<!-- ### Calculate signal to noise ratio for each cell type -->
<!-- ```{r} -->
<!-- all_results_tidy %>% -->
<!--   select(method, true_cell_type, signal, noise) %>% -->
<!--   distinct() %>%  -->
<!--   mutate(signal_to_noise = signal/(signal+noise)) %>%  -->
<!--   ggplot(aes(x=method, y=signal_to_noise)) +  -->
<!--     geom_boxplot(aes(fill=method), position = "dodge") +  -->
<!--     facet_wrap(~true_cell_type) +  -->
<!--     theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1)) + -->
<!--     scale_fill_manual(values=color_scales$methods) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- all_results_tidy %>% -->
<!--   select(method, true_cell_type, abs_noise) %>% -->
<!--   distinct() %>%  -->
<!--   filter(method %in% c("xcell", "quantiseq", "epic", "cibersort")) %>%  -->
<!--   ggplot(aes(x=method, y=abs_noise)) +  -->
<!--     geom_boxplot(aes(fill=method), position="dodge") +  -->
<!--     facet_wrap(~true_cell_type) +  -->
<!--     theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1)) + -->
<!--     scale_fill_manual(values=color_scales$methods) -->

<!-- ``` -->