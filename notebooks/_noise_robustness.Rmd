# Robustness against noise
We use random samples from TCGA, add different noise levels and check how the predictions of the different 
method compare to the original predictions. 

```{r, include=FALSE}
res_noise = new.env()
```

First, we retrieve 100 random samples from TCGA: 
```{r}
set.seed(42)

samples = tbl(tcga_db, "sample") %>%
  select(sample, cohort) %>% 
  collect() %>%
  filter(cohort %in% toupper(immunedeconv::timer_available_cancers)) %>% 
  sample_n(100)
          
sample_expr = tbl(tcga_db, "expression") %>% 
  filter(sample %in% samples$sample) %>% 
  select(sample, gene_symbol, tpm) %>% 
  collect()

```

```{r, echo=FALSE}
sample_mat = sample_expr %>% 
  spread(sample, tpm) %>% 
  as.data.frame() %>% 
  column_to_rownames("gene_symbol") %>% 
  as.matrix()

noise_mat = matrix(rnorm(length(sample_mat)), nrow = nrow(sample_mat), ncol = ncol(sample_mat))
```

Then we add noise to the samples. 
Noise is $\sim\mathsf{N}(0, \text{noise\_level})$. 

```{r}
noise_levels = c(0, 1, 5, 10)

sample_noise_mat = lapply(noise_levels, function(x) {
  tmp_mat = sample_mat + x * noise_mat
  colnames(tmp_mat) = paste0(colnames(sample_mat), "_", x)
  tmp_mat
}) 

sample_noise_mat = do.call("cbind", sample_noise_mat)
timer_indications = rep(samples$cohort, length(noise_levels))
```

We then run the deconvolution methods on both the original and the 'noisy' samples. 
```{r noise_generate_data, echo=FALSE}
noise_robustness_file = "../results/cache/noise_robustness.rda"

if(!file.exists(noise_robustness_file)) {
  all_results = foreach(method = immunedeconv::deconvolution_methods,
                        .final = function(x) setNames(x, immunedeconv::deconvolution_methods)) %dopar% {
                          deconvolute(sample_noise_mat, method, indications=timer_indications) 
                        }
  save(all_results, file=noise_robustness_file)
}
load(noise_robustness_file)
```

We consider the following cell types
```{r}
show_cell_types = c("B cell", "Dendritic cell", "Macrophage/Monocyte",
                    "NK cell", "T cell CD4+", "T cell CD4+ (non-regulatory)",
                    "T cell regulatory (Tregs)", "T cell CD8+",
                    "Cancer associated fibroblast", "Endothelial cell")
```

```{r, cache=TRUE, echo=FALSE}
all_results2 = lapply(names(all_results), function(method) {
  tmp_res = all_results[[method]] %>% 
    map_result_to_celltypes(show_cell_types, method) %>% 
    as_tibble(rownames="cell_type") %>% 
    gather(sample, estimate, -cell_type) %>% 
    mutate(method=method)
}) %>% bind_rows()

all_results3 = all_results2 %>% 
  separate(sample, into = c("sample", "noise_level"), sep="_", convert = TRUE) %>% 
  spread(noise_level, estimate) %>% 
  gather(noise_level, estimate, -sample, -cell_type, -method, -`0`) %>%
  rename(no_noise=`0`) %>% 
  mutate(noise_level=factor(noise_level, levels = noise_levels)) %>%
  na.omit()
```

## Result figures
```{r, fig.width=14, fig.height=14, echo=FALSE}
all_results3 %>% 
  filter(noise_level == 1) %>% 
  ggplot(aes(x=no_noise, y=estimate)) +
  stat_smooth(aes(color=method), method="lm") + 
  scale_color_manual(values=color_scales$methods) + 
  geom_point() + 
  stat_cor() + 
  facet_wrap(method~cell_type, scales = "free", ncol=8) + 
  theme_bw()

res_noise$all_results = all_results3
```

```{r, fig.width=14, fig.height=7, echo=FALSE}
all_results3 %>% 
  ggplot(aes(x=no_noise, y=estimate)) +
  geom_point(aes(color=cell_type)) + 
  stat_cor() + 
  facet_wrap(noise_level~method, scales = "free", nrow=length(noise_levels)-1) + 
  theme_bw()
```

### Correlations
```{r, cache=TRUE, echo=FALSE}
correlations = all_results3 %>%
  select(-sample) %>%
  group_by(method, cell_type, noise_level) %>%
  do(make_cor(.$no_noise, .$estimate)) %>% 
  ungroup()

res_noise$correlations = correlations
```


```{r, fig.width=12, fig.height=7, echo=FALSE}
correlations %>% ggplot(aes(x=method, y=pearson)) +
  geom_bar(stat="identity", aes(fill=method)) +
  geom_errorbar(aes(ymin=conf_int_lower, ymax=conf_int_upper), width=.2) + 
  facet_grid(noise_level~cell_type, labeller = label_wrap_gen()) + 
  theme_bw() + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position="top",
        strip.text.x = element_text(size=9)) +
  coord_cartesian(ylim=c(0,1)) + 
  scale_fill_manual(values=color_scales$methods)  

```


```{r, fig.width=10, fig.height=5, echo=FALSE, message=FALSE, warning=FALSE}
correlations %>% ggplot(aes(x=method, y=pearson)) +
  geom_boxplot() +
  geom_point(aes(color=cell_type)) + 
  facet_grid(~noise_level, labeller = label_wrap_gen()) + 
  theme_bw() + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position="right",
        strip.text.x = element_text(size=9)) 
#   scale_color_manual(values=color_scales$cell_types)  

```



