---
output:
  html_document:
    self_contained: true
---

```{r setup}
library(knitr)
library(ggplot2)
library(dplyr)
library(foreach)
library(tibble)
library(tidyr)
library(magrittr)
library(readr)
library(BioQC)
library(ggbeeswarm)
library(ggpubr)
opts_knit$set(self.contained=TRUE)
```

# Investigating Markers of DCs/B cells
```{r}
load("../data/schelker/single_cell_schelker.rda")
mat = cbind(pData(single_cell_schelker), t(exprs(single_cell_schelker))) %>% as_tibble() 
mat = mat %>% filter(source != "pbmc")
```

## Show B cell and DC marker across the t-SNE plot
```{r, fig.width=6, fig.height=6}
foreach(gene = c("MS4A1", "CD19", "ITGAM", "ITGAX", "CLEC4C", "IL3RA", "TCL1A"),
        cell_type = c("B cell", "B cell", "myleoid", "myleoid", "plasmacytoid DCs", "plasmacytoid DCs", "??")) %do% {
          mat %>% ggplot(aes(x=tsneX1, y=tsneX2)) + 
            geom_point(aes_string(colour=gene), size=.4) +
#            scale_colour_distiller(palette="RdBu") +
            ggtitle(paste(gene, "-", cell_type))
        }
```

**Conclusion**: The B cell and DC cluster separate well, the marker genes do not overlap. 
The DC cluster are plasmacytoid DCs, mDCs are somewhere hidden in the Macrophage/Monocyte cluster
and cannot be distinguished. 

```{r}
load("../results/cache/sensitivity_analysis_dataset.rda")
```


## Check expression of markers in "Sensitivity/Speicificity" simulation dataset. 
```{r}
show_cell_types = c("B cell", "Dendritic cell", "Macrophage/Monocyte",
                    "NK cell", "T cell CD4+", "T cell CD8+")
```

```{r, echo=FALSE}
n_immune_cells = rep(c(seq(0, 50, 5)
                     , seq(60, 100, 10)
                     , seq(150, 500, 50)
                     , seq(600, 1000, 100)
                     ), 5)
```


```{r}
alldata = foreach(celltype = names(sensitivity_analysis_dataset),
        .combine=bind_rows) %do% {
          sensitivity_analysis_dataset[[celltype]] %>% as.tibble(rownames="gene") %>% mutate(celltype=celltype)
  
        }
colname2ncell = data.frame(sample=colnames(sensitivity_analysis_dataset$`B cell`), ncell=n_immune_cells)
alldata2 = alldata %>% gather(sample, TPM, -gene, -celltype)
alldata2 %<>% inner_join(colname2ncell)
```


```{r, fig.cap="Correlation of marker genes with increase of the amount of a certain cell type. Along x-axis: cell type used for simulation. Along y-axis: groups of marker genes. ", fig.height=12, fig.width=12}
markers = list(
  "B cell" = c("MS4A1", #=CD20
               "CD19", "CD22"
  ), 
  "myleoid" = c("ITGAM", "ITGAX"), #=CD11B,CD11C
  "MHC class II" = c("HLA-DRB1", "HLA-DRA"),
  "plasmacytoid DC" = c("CLEC4C", "IL3RA"))
markers_df = foreach(cell_type = names(markers), genes=markers, .combine=bind_rows) %do% {
  data.frame(gene=genes) %>% mutate(markers_for=cell_type)
}
allmarkers = unlist(markers)
alldata2 %>% filter(gene %in% allmarkers) %>%
  inner_join(markers_df) %>%
  ggplot(aes(x=ncell, y=TPM)) +
    geom_point(aes(colour=gene)) +
    facet_grid(gene~celltype, scales = "free_y") + 
    scale_color_brewer(palette="Set3") + stat_cor()

alldata2 %>% filter(celltype == "Dendritic cell", gene == "MS4A1") %>% 
  ggplot(aes(x=ncell, y=TPM)) + 
  geom_point()+ 
  stat_smooth(method="lm") +
  stat_cor()
```

### Derive marker genes from quanTIseq/EPIC signature matrices. 
We use gini-index (Zhang et al. (2017), BMC genomics) to filter for highly discriminating genes
within the matrix. We select all genes with a gini index > 0.7. We assign all selected genes as marker gene
to the cell type in which it is expressed the most. 
In the end, we receive a list of signature genes for each cell type. 

```{r, message=FALSE, warning=FALSE}
til10 = read_tsv("../immunedeconv/inst/extdata/quantiseq/TIL10_signature.txt") %>% as.data.frame() %>%
  column_to_rownames("ID")
gini_index = apply(til10, 1, gini)
til10_gini = til10[gini_index > .7,]
til10_gini_rk = apply(til10_gini, 1, function(x) {rank(-x)}) %>% t()

quantiseq_markers = sapply(colnames(til10_gini_rk), function(cell_type) {
   rownames(til10_gini_rk)[til10_gini_rk[,cell_type] == 1]
}, simplify = FALSE, USE.NAMES = TRUE)
```

Same fore EPIC:
```{r}
tref = EPIC::TRef$refProfiles[EPIC::TRef$sigGenes,]
gini_index = apply(tref, 1, gini)
tref_gini = tref[gini_index > .7,]
tref_gini_rk = apply(tref, 1, function(x) {rank(-x)}) %>% t()

epic_markers = sapply(colnames(tref_gini_rk), function(cell_type) {
  rownames(tref_gini_rk)[tref_gini_rk[,cell_type] == 1]
}, simplify = FALSE, USE.NAMES = TRUE)
```

Same for CIBERSORT
```{r}
lm22 = read_tsv("../lib/CIBERSORT/LM22.txt") %>% as.data.frame() %>% column_to_rownames("Gene symbol")
gini_index = apply(tref, 1, gini)
lm22_gini = tref[gini_index > .7,]
lm22_gini_rk = apply(lm22, 1, function(x) {rank(-x)}) %>% t()

cibersort_markers = sapply(colnames(lm22_gini_rk), function(cell_type) {
  rownames(lm22_gini_rk)[lm22_gini_rk[,cell_type] == 1]
}, simplify = FALSE, USE.NAMES = TRUE)
```


```{r, fig.width=10, fig.height=15, warning=FALSE, message=FALSE, fig.cap="Expression across cell types. Along x-axis: cell types used for simulation. Along y-axis: Signature genes from EPIC/quanTIseq for the cell types. "}
marker_list = list(quantiseq=quantiseq_markers, epic=epic_markers, cibersort=cibersort_markers)
foreach(method = names(marker_list)) %do% {
  markers = marker_list[[method]]
  markers_df = foreach(cell_type = names(markers), genes=markers, .combine=bind_rows) %do% {
    data.frame(gene=genes) %>% mutate(markers_for=cell_type)
  }
  allmarkers = unlist(markers)
  alldata3 = alldata2 %>% filter(gene %in% allmarkers) %>%
    filter(ncell > 600) %>%
    inner_join(markers_df)
 
  alldata3 %>%
    ggplot(aes(x=gene, y=TPM)) +
      geom_boxplot() + 
      coord_flip() + 
      facet_grid(markers_for~celltype, scales = "free", space="free") + 
      scale_color_brewer(palette="Set1") + 
      theme(strip.text.y = element_text(angle=0)) + 
      ggtitle(method)
  ggsave(paste0("../results/figures/marker_gene_expression_", method, ".pdf"), width = 15, height = ifelse(method=="cibersort", 75, 15), limitsize=FALSE)
}

```



