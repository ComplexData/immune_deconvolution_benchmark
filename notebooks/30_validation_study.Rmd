---
title: "R Notebook"
output: html_notebook
---

# Validation with matched-bulk samples

Load the data and merge replicates
```{r}
ovarian_bulk_replicates = read_xls("../data/single_cell_schelker/ascites_bulk_samples.xls") 

samples = list("7873M"=c("ascites_7873_1", "ascites_7873_2"),
               "7882M"=c("ascites_7882_1", "ascites_7882_2"),
               "7892M"=c("ascites_7892_1", "ascites_7892_2"))

ovarian_bulk = lapply(samples, function(cols) {
  apply(ovarian_bulk_replicates[,cols], 1, mean)
}) %>% bind_cols() 

ovarian_bulk %<>% 
  mutate(gene_symbol = ovarian_bulk_replicates$Row)

ovarian_bulk_mat = ovarian_bulk %>%
  as.data.frame() %>%
  column_to_rownames("gene_symbol") %>%
  as.matrix()
```

Load the 'ground truth'
```{r}
true_cell_count = pData(single_cell_schelker2) %>% 
  filter(source == "ascites", donor %in% colnames(ovarian_bulk)) %>% 
  group_by(donor, cell_type) %>% 
  count() %>% 
  arrange(cell_type, donor)

total_cells = true_cell_count %>% 
  group_by(donor) %>%
  summarise(sum(n))

total_cells
true_cell_count

```


## Run the deconvolution
We first run all methods that are integrated in the `immune_deconvolution_methods` are package automatically in a loop. 
```{r, cache=TRUE}
all_results = lapply(immunedeconv::deconvolution_methods, function(method) {
  deconvolute(ovarian_bulk_mat, method) %>%
    mutate(method=method)
})
```

### run CIBERSORT
We could not include CIBERSORT [@CIBERSORT2016] into the package due to licensing restrictions. 
In the following, we run CIBERSORT both in "normal" and "absolute" mode. 

```{r, cache=TRUE}
res_cibersort = immunedeconv::deconvolute_cibersort(ovarian_bulk_mat, 
                                                    "../lib/CIBERSORT/CIBERSORT.R",
                                                    "../lib/CIBERSORT/LM22.txt") 
res_cibersort %<>% mutate(method="cibersort")

res_cibersort_abs = immunedeconv::deconvolute_cibersort(ovarian_bulk_mat, 
                                                    "../lib/CIBERSORT/CIBERSORT.R",
                                                    "../lib/CIBERSORT/LM22.txt",
                                                    absolute = TRUE) 
res_cibersort_abs %<>% mutate(method="cibersort_abs")
```

### run TIMER
TIMER [@TIMER2016] is only available as a web resource. Moreover, the algorithm is adapted for each cancer type, so that we have to choose the corresponding option (Melanoma/Ovarian) when running the algorithm. 

We therefore export the data required to run the algorithm and re-import the results obtained from the web-tool. 

```{r, cache=TRUE}
immunedeconv::export_for_timer(ovarian_bulk_mat, path="../results/timer_input_ovarian_bulk.tsv")

res_timer = immunedeconv::import_from_timer("../data/timer/timer_result_ovarian_bulk.csv") %>%
  mutate(method="timer")
```

```{r, cache=TRUE}
all_results %<>% 
  c(list(res_cibersort)) %>%
  c(list(res_cibersort_abs)) %>% 
  c(list(res_timer))

# summarise cell_types from the method that only map to a single cell_type in the reference dataset (namely monocytes and macrophages)
all_results2 = lapply(all_results, function(res) {
  res %>% 
    map_results_to_dataset("single_cell_schelker") %>% 
    group_by(method, single_cell_schelker) %>%   
    summarise_all(funs(sum)) 
})

all_results_tidy = all_results2 %>%
  bind_rows() %>%
  rename(cell_type = single_cell_schelker) %>%
  gather(sample, estimate, -cell_type, -method) %>%
  arrange(method, cell_type, sample)
```


CAUTION: this plot does not entirely make sense, as e.g. MCP counter cannot be compared *between cell_types* only *between-samples*. 
```{r, fig.width=10, figh.height=10}
all_results_tidy %>%
  rbind(true_cell_count %>% mutate(method="TRUE") %>% rename(sample=donor, estimate=n)) %>%
  group_by(method, sample) %>%
  mutate(estimate_scaled = (estimate - min(estimate)) / (max(estimate) - min(estimate))) %>% 
  ggplot(aes(x=sample, y=cell_type)) + 
  geom_tile(aes(fill=estimate_scaled)) + 
  facet_wrap(~method) + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5, hjust=1))

```