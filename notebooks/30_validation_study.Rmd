# Validation with real data
We the curated datasets with gold standard as an additional validation on top of the mixing study. 


## Run the deconvolution
We first run all methods that are integrated in the `immune_deconvolution_methods` are package automatically in a loop. 
```{r, cache=TRUE}
datasets = list(
  racle=racle,
  hoeck=hoeck,
  schelker_ovarian=schelker_ovarian
)

all_results = foreach(dataset=datasets, dataset_name=names(datasets), .combine=bind_rows) %:%
  foreach(method = immunedeconv::deconvolution_methods, .combine=bind_rows) %dopar% {
    deconvolute(dataset$expr_mat, method) %>%
      gather(sample, estimate, -cell_type) %>%
      mutate(method=method, dataset=dataset_name)
}

all_refs = foreach(dataset=datasets, dataset_name=names(datasets), .combine=bind_rows) %do% {
  dataset$ref %>% 
    select(sample, cell_type, true_fraction) %>%
    mutate(dataset=dataset_name)
}

all_results_ref = inner_join(all_results, all_refs, by=c("sample"="sample", "dataset"="dataset", "cell_type"="cell_type"))
```


```{r, cache=TRUE, eval=FALSE}
# immunedeconv::export_for_timer(ovarian_bulk_mat, path="../results/timer_input_ovarian_bulk.tsv")
# 
# res_timer = immunedeconv::import_from_timer("../data/timer/timer_result_ovarian_bulk.csv") %>%
#   mutate(method="timer")
```



```{r, fig.width=10, fig.height=6}
all_results_ref %>% filter(cell_type == "B cell") %>%
  ggplot(aes(x=true_fraction, y=estimate)) + geom_point(aes(color=method, shape=dataset)) + 
  scale_color_manual(values=color_scales$methods) + 
  facet_wrap(~method, scales = "free") + 
  stat_cor() + 
  ggtitle("B cells")

```

